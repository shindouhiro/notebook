# Go ç•™è¨€å›å¤åŠŸèƒ½

> ğŸ”— **å…³è”ç¬”è®°**ï¼š[[ç•™è¨€ç³»ç»Ÿé¡¹ç›®å®æˆ˜]]
> ğŸ“… **åˆ›å»ºæ—¶é—´**ï¼š2024-12-24

---

## ğŸ“– æ¦‚è¿°

å®ç°ç•™è¨€çš„å›å¤åŠŸèƒ½ï¼Œæ”¯æŒå¤šçº§åµŒå¥—å›å¤ï¼Œæ„å»ºæ ‘å½¢ç»“æ„çš„è¯„è®ºç³»ç»Ÿã€‚

---

## ğŸ› ï¸ å®ç°æ­¥éª¤

### 1. ä¿®æ”¹ç•™è¨€æ¨¡å‹ (æ·»åŠ å›å¤å…³è”)

```go
// models/message.go
package models

import (
	"time"

	"gorm.io/gorm"
)

// Message ç•™è¨€æ¨¡å‹ (æ”¯æŒå›å¤)
type Message struct {
	ID        uint           `json:"id" gorm:"primaryKey"`
	Author    string         `json:"author" gorm:"size:100;not null"`
	Content   string         `json:"content" gorm:"type:text;not null"`
	Email     string         `json:"email" gorm:"size:100"`
	
	// å›å¤å…³è”
	ParentID  *uint          `json:"parent_id" gorm:"index"`           // çˆ¶ç•™è¨€ID (ä¸ºç©ºè¡¨ç¤ºé¡¶çº§ç•™è¨€)
	Parent    *Message       `json:"parent,omitempty" gorm:"foreignKey:ParentID"`
	Replies   []Message      `json:"replies,omitempty" gorm:"foreignKey:ParentID"`
	
	// å±‚çº§ä¿¡æ¯
	Level     int            `json:"level" gorm:"default:0"`           // å›å¤å±‚çº§ (0=é¡¶çº§)
	
	CreatedAt time.Time      `json:"created_at"`
	UpdatedAt time.Time      `json:"updated_at"`
	DeletedAt gorm.DeletedAt `json:"-" gorm:"index"`
}

// TableName è‡ªå®šä¹‰è¡¨å
func (Message) TableName() string {
	return "messages"
}
```

### 2. å›å¤å¤„ç†å™¨

```go
// handlers/reply.go
package handlers

import (
	"message-board/config"
	"message-board/models"
	"net/http"

	"github.com/gin-gonic/gin"
)

// ReplyInput å›å¤è¾“å…¥
type ReplyInput struct {
	Author  string `json:"author" binding:"required"`
	Content string `json:"content" binding:"required"`
	Email   string `json:"email"`
}

// CreateReply åˆ›å»ºå›å¤
func CreateReply(c *gin.Context) {
	parentID := c.Param("id")
	
	// æŸ¥æ‰¾çˆ¶ç•™è¨€
	var parentMessage models.Message
	if err := config.DB.First(&parentMessage, parentID).Error; err != nil {
		c.JSON(http.StatusNotFound, gin.H{"error": "ç•™è¨€ä¸å­˜åœ¨"})
		return
	}
	
	var input ReplyInput
	if err := c.ShouldBindJSON(&input); err != nil {
		c.JSON(http.StatusBadRequest, gin.H{"error": err.Error()})
		return
	}
	
	// åˆ›å»ºå›å¤
	reply := models.Message{
		Author:   input.Author,
		Content:  input.Content,
		Email:    input.Email,
		ParentID: &parentMessage.ID,
		Level:    parentMessage.Level + 1,
	}
	
	if err := config.DB.Create(&reply).Error; err != nil {
		c.JSON(http.StatusInternalServerError, gin.H{"error": "å›å¤å¤±è´¥"})
		return
	}
	
	c.JSON(http.StatusCreated, gin.H{
		"message": "å›å¤æˆåŠŸ",
		"data":    reply,
	})
}

// GetMessageWithReplies è·å–ç•™è¨€åŠå…¶æ‰€æœ‰å›å¤
func GetMessageWithReplies(c *gin.Context) {
	id := c.Param("id")
	
	var message models.Message
	
	// é¢„åŠ è½½å›å¤ (é€’å½’åŠ è½½)
	if err := config.DB.
		Preload("Replies", func(db *gorm.DB) *gorm.DB {
			return db.Order("created_at asc")
		}).
		Preload("Replies.Replies"). // äºŒçº§å›å¤
		Preload("Replies.Replies.Replies"). // ä¸‰çº§å›å¤
		First(&message, id).Error; err != nil {
		c.JSON(http.StatusNotFound, gin.H{"error": "ç•™è¨€ä¸å­˜åœ¨"})
		return
	}
	
	c.JSON(http.StatusOK, gin.H{"data": message})
}

// GetTopLevelMessages è·å–æ‰€æœ‰é¡¶çº§ç•™è¨€ (å¸¦å›å¤)
func GetTopLevelMessages(c *gin.Context) {
	var messages []models.Message
	
	// åªè·å–é¡¶çº§ç•™è¨€ (ParentID ä¸ºç©º)
	if err := config.DB.
		Where("parent_id IS NULL").
		Preload("Replies", func(db *gorm.DB) *gorm.DB {
			return db.Order("created_at asc")
		}).
		Preload("Replies.Replies").
		Order("created_at desc").
		Find(&messages).Error; err != nil {
		c.JSON(http.StatusInternalServerError, gin.H{"error": "æŸ¥è¯¢å¤±è´¥"})
		return
	}
	
	c.JSON(http.StatusOK, gin.H{
		"data":  messages,
		"total": len(messages),
	})
}
```

### 3. é€’å½’æ„å»ºå›å¤æ ‘ (å¯é€‰ä¼˜åŒ–)

```go
// handlers/reply_tree.go
package handlers

import (
	"message-board/config"
	"message-board/models"
)

// MessageTree ç•™è¨€æ ‘ç»“æ„
type MessageTree struct {
	models.Message
	Children []MessageTree `json:"children"`
}

// BuildReplyTree æ„å»ºå›å¤æ ‘
func BuildReplyTree(messages []models.Message, parentID *uint) []MessageTree {
	var tree []MessageTree
	
	for _, msg := range messages {
		// æ¯”è¾ƒ parentID
		if (parentID == nil && msg.ParentID == nil) || 
		   (parentID != nil && msg.ParentID != nil && *parentID == *msg.ParentID) {
			node := MessageTree{
				Message:  msg,
				Children: BuildReplyTree(messages, &msg.ID),
			}
			tree = append(tree, node)
		}
	}
	
	return tree
}

// GetAllMessagesAsTree è·å–æ‰€æœ‰ç•™è¨€æ„å»ºæ ‘
func GetAllMessagesAsTree(c *gin.Context) {
	var messages []models.Message
	
	if err := config.DB.
		Order("created_at asc").
		Find(&messages).Error; err != nil {
		c.JSON(http.StatusInternalServerError, gin.H{"error": "æŸ¥è¯¢å¤±è´¥"})
		return
	}
	
	tree := BuildReplyTree(messages, nil)
	
	c.JSON(http.StatusOK, gin.H{"data": tree})
}
```

### 4. æ·»åŠ è·¯ç”±

```go
// routes/routes.go
messages := api.Group("/messages")
{
	messages.POST("/:id/reply", handlers.CreateReply)           // å›å¤ç•™è¨€
	messages.GET("/:id/replies", handlers.GetMessageWithReplies) // è·å–ç•™è¨€åŠå›å¤
	messages.GET("/tree", handlers.GetTopLevelMessages)          // æ ‘å½¢ç»“æ„
}
```

---

## ğŸ§ª æµ‹è¯•ç¤ºä¾‹

```bash
# 1. åˆ›å»ºé¡¶çº§ç•™è¨€
curl -X POST http://localhost:8080/api/messages \
  -H "Content-Type: application/json" \
  -d '{"author": "å¼ ä¸‰", "content": "è¿™æ˜¯ä¸€æ¡é¡¶çº§ç•™è¨€"}'

# 2. å›å¤ç•™è¨€ (å‡è®¾ç•™è¨€IDä¸º1)
curl -X POST http://localhost:8080/api/messages/1/reply \
  -H "Content-Type: application/json" \
  -d '{"author": "æå››", "content": "è¿™æ˜¯å¯¹å¼ ä¸‰çš„å›å¤"}'

# 3. è·å–ç•™è¨€åŠå›å¤
curl http://localhost:8080/api/messages/1/replies

# 4. è·å–æ ‘å½¢ç»“æ„
curl http://localhost:8080/api/messages/tree
```

---

## ğŸ“Š å“åº”ç¤ºä¾‹

```json
{
  "data": {
    "id": 1,
    "author": "å¼ ä¸‰",
    "content": "è¿™æ˜¯ä¸€æ¡é¡¶çº§ç•™è¨€",
    "replies": [
      {
        "id": 2,
        "author": "æå››",
        "content": "è¿™æ˜¯å¯¹å¼ ä¸‰çš„å›å¤",
        "parent_id": 1,
        "level": 1,
        "replies": []
      }
    ]
  }
}
```

---

## ğŸ“š ç›¸å…³ç¬”è®°

- [[ç•™è¨€ç³»ç»Ÿé¡¹ç›®å®æˆ˜]] - ä¸»é¡¹ç›®
- [[JWTç”¨æˆ·è®¤è¯]] - ç”¨æˆ·è®¤è¯

---

#Go #GORM #å›å¤ #æ ‘å½¢ç»“æ„ #åç«¯å¼€å‘
