# ç¼–è¯‘ä¼˜åŒ–ç­–ç•¥

> ğŸ”— **å…³è”ç¬”è®°**ï¼š[[Vue3æºç å®æˆ˜ç¬”è®°]]
> ğŸ“… **åˆ›å»ºæ—¶é—´**ï¼š2024-12-24
> ğŸ“ **æºç ä½ç½®**ï¼š`packages/compiler-core/src/transforms/`

---

## ğŸ“– ä¼˜åŒ–ç­–ç•¥

Vue 3 ç¼–è¯‘å™¨çš„ä¼˜åŒ–ç­–ç•¥ï¼š

1. **é™æ€æå‡ (hoistStatic)**
2. **è¡¥ä¸æ ‡è®° (PatchFlags)**
3. **æ ‘ç»“æ„æ‰“å¹³ (Block Tree)**
4. **ç¼“å­˜äº‹ä»¶å¤„ç†å™¨**

---

## ğŸš€ é™æ€æå‡

```html
<div>
  <p>é™æ€æ–‡æœ¬</p>
  <p>{{ dynamic }}</p>
</div>
```

ç¼–è¯‘åï¼š

```javascript
// é™æ€å†…å®¹è¢«æå‡åˆ°æ¸²æŸ“å‡½æ•°å¤–éƒ¨
const _hoisted_1 = h('p', null, 'é™æ€æ–‡æœ¬')

function render(_ctx) {
  return h('div', null, [
    _hoisted_1, // å¤ç”¨ï¼Œä¸é‡æ–°åˆ›å»º
    h('p', null, _ctx.dynamic)
  ])
}
```

---

## ğŸ·ï¸ PatchFlags

```typescript
export const enum PatchFlags {
  TEXT = 1,           // åŠ¨æ€æ–‡æœ¬
  CLASS = 1 << 1,     // åŠ¨æ€ class
  STYLE = 1 << 2,     // åŠ¨æ€ style
  PROPS = 1 << 3,     // åŠ¨æ€å±æ€§
  FULL_PROPS = 1 << 4, // æœ‰åŠ¨æ€ key
  // ...
}

// diff æ—¶åªæ¯”å¯¹æ ‡è®°çš„éƒ¨åˆ†
if (patchFlag & PatchFlags.TEXT) {
  // åªæ›´æ–°æ–‡æœ¬
}
```

---

## ğŸ“¦ Block Tree

å°†åŠ¨æ€èŠ‚ç‚¹æ”¶é›†åˆ° block ä¸­ï¼Œdiff æ—¶åªå¯¹æ¯”åŠ¨æ€èŠ‚ç‚¹ã€‚

```javascript
function render() {
  return openBlock(), createBlock('div', null, [
    // dynamicChildren åªåŒ…å«åŠ¨æ€èŠ‚ç‚¹
  ])
}
```

---

## ğŸ“š ç›¸å…³ç¬”è®°

- [[Vue3æºç å®æˆ˜ç¬”è®°]] - ä¸»ç¬”è®°
- [[æ¨¡æ¿ç¼–è¯‘æµç¨‹]] - ç¼–è¯‘æµç¨‹

#Vue3 #ç¼–è¯‘ä¼˜åŒ– #æºç åˆ†æ
