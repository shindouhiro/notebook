# 生命周期实现

> 🔗 **关联笔记**：[[Vue3源码实战笔记]]
> 📅 **创建时间**：2024-12-24
> 📁 **源码位置**：`packages/runtime-core/src/apiLifecycle.ts`

---

## 📖 生命周期钩子

| Vue 3 | Vue 2 | 说明 |
|-------|-------|------|
| `onBeforeMount` | `beforeMount` | 挂载前 |
| `onMounted` | `mounted` | 挂载后 |
| `onBeforeUpdate` | `beforeUpdate` | 更新前 |
| `onUpdated` | `updated` | 更新后 |
| `onBeforeUnmount` | `beforeDestroy` | 卸载前 |
| `onUnmounted` | `destroyed` | 卸载后 |

---

## 🔧 实现原理

```typescript
// 当前正在 setup 的组件实例
let currentInstance = null

function setCurrentInstance(instance) {
  currentInstance = instance
}

// 创建生命周期注册函数
function createHook(lifecycle) {
  return (hook) => {
    if (currentInstance) {
      // 将钩子函数添加到组件实例
      const hooks = currentInstance[lifecycle] || (currentInstance[lifecycle] = [])
      hooks.push(hook)
    }
  }
}

export const onBeforeMount = createHook('bm')
export const onMounted = createHook('m')
export const onBeforeUpdate = createHook('bu')
export const onUpdated = createHook('u')
export const onBeforeUnmount = createHook('bum')
export const onUnmounted = createHook('um')
```

---

## 🎯 调用时机

```typescript
function setupRenderEffect(instance, container) {
  const componentUpdateFn = () => {
    if (!instance.isMounted) {
      // 调用 onBeforeMount
      invokeArrayFns(instance.bm)
      
      // 渲染
      const subTree = instance.render.call(instance.proxy)
      patch(null, subTree, container)
      
      // 调用 onMounted (需要在 DOM 更新后)
      queuePostFlushCb(() => invokeArrayFns(instance.m))
      
      instance.isMounted = true
    } else {
      // 调用 onBeforeUpdate
      invokeArrayFns(instance.bu)
      
      // 更新渲染
      patch(prevTree, nextTree, container)
      
      // 调用 onUpdated
      queuePostFlushCb(() => invokeArrayFns(instance.u))
    }
  }
}
```

---

## 📚 相关笔记

- [[Vue3源码实战笔记]] - 主笔记
- [[组件实例化流程]] - 组件挂载

#Vue3 #生命周期 #源码分析
