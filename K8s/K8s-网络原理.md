# K8s ç½‘ç»œåŸç†

## ğŸŒ ç½‘ç»œæ¨¡å‹

Kubernetes ç½‘ç»œéµå¾ªä»¥ä¸‹åŸºæœ¬åŸåˆ™ï¼š

1. **æ¯ä¸ª Pod æœ‰ç‹¬ç«‹ IP**
2. **Pod ä¹‹é—´å¯ä»¥ç›´æ¥é€šä¿¡**ï¼ˆä¸éœ€è¦ NATï¼‰
3. **Node ä¸ Pod å¯ä»¥ç›´æ¥é€šä¿¡**
4. **Pod çœ‹åˆ°çš„è‡ªå·± IP ä¸å…¶ä»–äººçœ‹åˆ°çš„ç›¸åŒ**

---

## ğŸ”— ç½‘ç»œå±‚æ¬¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    K8s ç½‘ç»œå±‚æ¬¡                          â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚           Ingress Layer (L7)                      â”‚  â”‚
â”‚  â”‚     åŸŸåè·¯ç”±ã€SSL ç»ˆæ­¢ã€è´Ÿè½½å‡è¡¡                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â”‚                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚           Service Layer (L4)                      â”‚  â”‚
â”‚  â”‚     æœåŠ¡å‘ç°ã€è´Ÿè½½å‡è¡¡ã€ClusterIP                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â”‚                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚           Pod Network (CNI)                       â”‚  â”‚
â”‚  â”‚     Pod IP åˆ†é…ã€Pod é—´é€šä¿¡                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â”‚                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚           Node Network                            â”‚  â”‚
â”‚  â”‚     ç‰©ç†/è™šæ‹Ÿæœºç½‘ç»œ                               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”Œ CNIï¼ˆå®¹å™¨ç½‘ç»œæ¥å£ï¼‰

### å¸¸è§ CNI æ’ä»¶å¯¹æ¯”

| æ’ä»¶ | ç‰¹ç‚¹ | é€‚ç”¨åœºæ™¯ |
|-----|------|---------|
| **Calico** | é«˜æ€§èƒ½ã€æ”¯æŒç½‘ç»œç­–ç•¥ | ç”Ÿäº§é¦–é€‰ |
| **Flannel** | ç®€å•æ˜“ç”¨ | å…¥é—¨å­¦ä¹  |
| **Cilium** | eBPFã€å®‰å…¨å¼ºå¤§ | é«˜çº§éœ€æ±‚ |
| **Weave** | ç®€å•ã€åŠ å¯† | å°è§„æ¨¡ |

### Calico ç½‘ç»œæ¶æ„

```
Node 1                           Node 2
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”‚             â”‚ â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚Pod Aâ”‚ â”‚Pod Bâ”‚ â”‚             â”‚ â”‚Pod Câ”‚ â”‚Pod Dâ”‚ â”‚
â”‚ â””â”€â”€â”¬â”€â”€â”˜ â””â”€â”€â”¬â”€â”€â”˜ â”‚             â”‚ â””â”€â”€â”¬â”€â”€â”˜ â””â”€â”€â”¬â”€â”€â”˜ â”‚
â”‚    â”‚       â”‚    â”‚             â”‚    â”‚       â”‚    â”‚
â”‚ â”Œâ”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â” â”‚             â”‚ â”Œâ”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â” â”‚
â”‚ â”‚   vRouter   â”‚ â”‚â—„â”€â”€â”€BGPâ”€â”€â”€â”€â–ºâ”‚ â”‚   vRouter   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â”‚             â”‚ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                               â”‚
    â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€
                  ç‰©ç†ç½‘ç»œ
```

---

## ğŸ¯ Service è¯¦è§£

### Service ç±»å‹

#### ClusterIPï¼ˆé»˜è®¤ï¼‰

```yaml
apiVersion: v1
kind: Service
metadata:
  name: my-service
spec:
  type: ClusterIP
  selector:
    app: myapp
  ports:
  - port: 80
    targetPort: 8080
```

**å·¥ä½œåŸç†ï¼š**
```
Client (Pod) â”€â”€â–º ClusterIP:Port â”€â”€â–º kube-proxy â”€â”€â–º Pod:TargetPort
              (è™šæ‹Ÿ IP)         (iptables/IPVS)
```

#### NodePort

```yaml
apiVersion: v1
kind: Service
metadata:
  name: my-service
spec:
  type: NodePort
  selector:
    app: myapp
  ports:
  - port: 80
    targetPort: 8080
    nodePort: 30080  # å¯é€‰ï¼ŒèŒƒå›´ 30000-32767
```

**è®¿é—®æ–¹å¼ï¼š** `<NodeIP>:30080`

#### LoadBalancer

```yaml
apiVersion: v1
kind: Service
metadata:
  name: my-service
spec:
  type: LoadBalancer
  selector:
    app: myapp
  ports:
  - port: 80
    targetPort: 8080
```

**äº‘å‚å•†ä¼šè‡ªåŠ¨åˆ›å»ºè´Ÿè½½å‡è¡¡å™¨**

#### Headless Service

```yaml
apiVersion: v1
kind: Service
metadata:
  name: my-headless
spec:
  clusterIP: None  # æ—  ClusterIP
  selector:
    app: myapp
  ports:
  - port: 80
```

**ç”¨é€”ï¼š** ç›´æ¥è¿”å› Pod IPï¼Œç”¨äº StatefulSet

---

## ğŸ”€ kube-proxy æ¨¡å¼

### iptables æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Client    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  ClusterIP  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                    iptables è§„åˆ™
                           â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â–¼              â–¼              â–¼
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚  Pod 1  â”‚   â”‚  Pod 2  â”‚   â”‚  Pod 3  â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  éšæœºè´Ÿè½½å‡è¡¡
```

### IPVS æ¨¡å¼ï¼ˆæ¨èç”Ÿäº§ä½¿ç”¨ï¼‰

ä¼˜åŠ¿ï¼š
- æ›´å¥½çš„æ€§èƒ½ï¼ˆO(1) vs O(n)ï¼‰
- æ›´å¤šè´Ÿè½½å‡è¡¡ç®—æ³•
- æ”¯æŒæ›´å¤šè¿æ¥

```bash
# å¯ç”¨ IPVS æ¨¡å¼
kubectl edit configmap kube-proxy -n kube-system
# è®¾ç½® mode: "ipvs"
```

---

## ğŸšª Ingress

### åŸºæœ¬æ¦‚å¿µ

```
                    Internet
                        â”‚
                        â–¼
             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚   Ingress Controller â”‚
             â”‚   (Nginx/Traefik)   â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                               â”‚
   foo.example.com              bar.example.com
        â”‚                               â”‚
        â–¼                               â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  Service A  â”‚               â”‚  Service B  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Ingress é…ç½®

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: my-ingress
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"
spec:
  ingressClassName: nginx
  tls:
  - hosts:
    - myapp.example.com
    secretName: myapp-tls
  rules:
  - host: myapp.example.com
    http:
      paths:
      - path: /api
        pathType: Prefix
        backend:
          service:
            name: api-service
            port:
              number: 80
      - path: /
        pathType: Prefix
        backend:
          service:
            name: frontend-service
            port:
              number: 80
```

### å¸¸è§ Ingress Controller

| æ§åˆ¶å™¨ | ç‰¹ç‚¹ |
|-------|------|
| **Nginx Ingress** | æœ€æµè¡Œï¼ŒåŠŸèƒ½ä¸°å¯Œ |
| **Traefik** | é…ç½®ç®€å•ï¼Œè‡ªåŠ¨å‘ç° |
| **HAProxy** | é«˜æ€§èƒ½ |
| **Kong** | API ç½‘å…³åŠŸèƒ½ |

---

## ğŸ”’ NetworkPolicy

é™åˆ¶ Pod é—´çš„ç½‘ç»œè®¿é—®ã€‚

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-frontend
spec:
  podSelector:
    matchLabels:
      app: backend
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: frontend
    ports:
    - protocol: TCP
      port: 8080
```

**æ•ˆæœï¼š** åªå…è®¸ `app=frontend` çš„ Pod è®¿é—® `app=backend` çš„ 8080 ç«¯å£

---

## ğŸ” DNS æœåŠ¡

### CoreDNS

K8s å†…ç½® DNS æœåŠ¡ï¼Œæä¾›æœåŠ¡å‘ç°ã€‚

**DNS è®°å½•æ ¼å¼ï¼š**
```
<service-name>.<namespace>.svc.cluster.local
```

**ç¤ºä¾‹ï¼š**
```bash
# åœ¨ Pod å†…è®¿é—®åŒå‘½åç©ºé—´çš„æœåŠ¡
curl http://my-service

# è·¨å‘½åç©ºé—´è®¿é—®
curl http://my-service.other-namespace
curl http://my-service.other-namespace.svc.cluster.local

# StatefulSet Pod DNS
# <pod-name>.<headless-service>.<namespace>.svc.cluster.local
curl http://mysql-0.mysql-headless.default.svc.cluster.local
```

---

## ğŸ› ï¸ è°ƒè¯•å‘½ä»¤

```bash
# æŸ¥çœ‹ Service
kubectl get svc -o wide
kubectl describe svc <service-name>

# æŸ¥çœ‹ Endpoints
kubectl get endpoints

# æŸ¥çœ‹ Ingress
kubectl get ingress
kubectl describe ingress <ingress-name>

# ç½‘ç»œæµ‹è¯•ï¼ˆä½¿ç”¨ debug Podï¼‰
kubectl run nettest --image=nicolaka/netshoot -it --rm -- bash

# åœ¨ debug Pod å†…
nslookup my-service
curl http://my-service:80
traceroute 10.96.0.1

# æŸ¥çœ‹ iptables è§„åˆ™
kubectl exec -n kube-system <kube-proxy-pod> -- iptables -L -t nat
```

---

è¿”å› [[K8så¿«é€Ÿå…¥é—¨]]

#K8s #ç½‘ç»œ #Service #Ingress
